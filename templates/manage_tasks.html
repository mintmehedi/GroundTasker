{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/manage_tasks.css' %}">
{% endblock %}

{% block content %}
<div class="manage-tasks-container">
  <div class="tabs">
    <a href="#" class="tab" data-tab="watchlist">🔖 Watchlist</a>
    <a href="#" class="tab active" data-tab="posted">📤 Posted Tasks</a>
    <a href="#" class="tab" data-tab="applied">📩 Applied</a>
    <a href="#" class="tab" data-tab="engaged">✅ Task Engaged</a>
  </div>

  <!-- Watchlist Section -->
  <div class="tab-panel" id="tab-watchlist" style="display: none;">
    {% if bookmarked_tasks %}
      {% for task in bookmarked_tasks %}
        <div class="task-card">
          <h3>{{ task.title }}</h3>
          <p>📍 {{ task.location }}<br>💰 ${{ task.budget }}</p>
          <div class="card-actions">
            <a href="{% url 'job_detail' task.id %}" class="btn-outline">View Details</a>
            <button class="btn-reject">Remove</button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No bookmarked tasks yet.</p>
    {% endif %}
  </div>

  <!-- Posted Tasks Section -->
  <div class="tab-panel" id="tab-posted">
    {% if posted_tasks %}
      {% for task in posted_tasks %}
        <div class="task-card">
          <div class="task-header">
            <h3>{{ task.title }}</h3>
            <span class="task-budget">${{ task.budget }}</span>
          </div>
          <p class="task-meta">📍 {{ task.location }}<br>📅 {{ task.preferred_date }}  ⏰ {{ task.preferred_time }}</p>

          <div class="card-actions">
            <a href="{% url 'job_detail' task.id %}" class="btn-outline>">View Details</a>
            <a href="{% url 'post_task' %}?edit={{ task.id }}" class="btn-outline">Edit</a>
            <button class="btn-reject">Delete</button>
          </div>

          {% if task.offers.all %}
            <div class="offer-section">
              <h5>Offers:</h5>
              {% for offer in task.offers.all %}
              <div class="offer-card">
                <p><strong>{{ offer.offered_by.username }}</strong> — ${{ offer.amount }}</p>
                <p class="offer-msg">"{{ offer.message }}"</p>
                <p>Status: {{ offer.status|capfirst }}</p>
                <div class="offer-actions">
                  <button class="btn-accept">Accept</button>
                  <button class="btn-reject">Reject</button>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="no-offers">No offers yet for this task.</p>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>You haven’t posted any tasks yet.</p>
    {% endif %}
  </div>

  <!-- Applied Section -->
  <div class="tab-panel" id="tab-applied" style="display: none;">
    {% if applied_offers %}
      {% for offer in applied_offers %}
        <div class="task-card">
          <h3>{{ offer.task.title }}</h3>
          <p>📍 {{ offer.task.location }}<br>💰 ${{ offer.amount }}</p>
          <p>Status: <span class="badge badge-{{ offer.status }}">{{ offer.status|capfirst }}</span></p>
          <p class="offer-msg">Your message: "{{ offer.message }}"</p>
          <div class="card-actions">
            <a href="#" class="btn-outline">Edit Offer</a>
            <button class="btn-reject">Withdraw</button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>You haven’t applied to any tasks yet.</p>
    {% endif %}
  </div>


<!-- Engaged Section -->
<div class="tab-panel" id="tab-engaged" style="display: none;">
  {% if engaged_offers %}
    {% for offer in engaged_offers %}
      <div class="task-card" id="engaged-task-{{ offer.task.id }}">
        <h3>{{ offer.task.title }}</h3>
        <p>📍 {{ offer.task.location }}<br>💰 ${{ offer.amount }}</p>
        <p>Engaged with: <strong>{{ offer.task.username }}</strong></p>
        <p class="offer-msg">"{{ offer.message }}"</p>
        <div class="card-actions">
          <button class="btn-accept" onclick="markComplete('{{ offer.id }}')">Mark Complete</button>
          <a href="{% url 'messages' %}?task_id={{ offer.task.id }}" class="btn btn-sm btn-outline-primary">Message</a>
        </div>
        <p class="completion-msg" id="completed-{{ offer.id }}" style="display: none; margin-top: 10px; color: green; font-weight: bold;">
          ✅ Task marked as completed!
        </p>
      </div>
    {% endfor %}
  {% else %}
    <p>No engaged tasks yet.</p>
  {% endif %}
  <!-- here I tried to show the sample data task id 1 from views but it is not showing
 enggaged page but working on the message page  -->
</div>



<script>
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-panel');

  tabs.forEach(tab => {
    tab.addEventListener('click', e => {
      e.preventDefault();
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      panels.forEach(panel => panel.style.display = 'none');
      const target = tab.dataset.tab;
      document.getElementById('tab-' + target).style.display = 'block';
    });
  });


  function markComplete(offerId) {
    const button = document.querySelector(`#engaged-task-${offerId} .btn-accept`);
    const msg = document.getElementById(`completed-${offerId}`);

    button.disabled = true;
    button.textContent = 'Completed';
    button.style.backgroundColor = '#9ca3af'; // muted color
    msg.style.display = 'block';
  }


</script>
{% endblock %}

<!--
  BACKEND NOTE:
  Later, hook the 'Mark Complete' button to a real URL like:
  <form method="POST" action="{% url 'mark_complete' offer.id %}">
    {% csrf_token %}
    <button type="submit" class="btn-accept">Mark Complete</button>
  </form>
-->
