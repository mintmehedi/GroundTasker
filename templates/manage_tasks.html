{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/manage_tasks.css' %}">
{% endblock %}

{% block content %}
<div class="manage-tasks-container">
  <div class="tabs">
    <a href="#" class="tab" data-tab="watchlist">ğŸ”– Watchlist</a>
    <a href="#" class="tab active" data-tab="posted">ğŸ“¤ Posted Tasks</a>
    <a href="#" class="tab" data-tab="applied">ğŸ“© Applied</a>
    <a href="#" class="tab" data-tab="engaged">â³ Task Engaged</a>
    <a href="#" class="tab" data-tab="completed">ğŸ Completed Tasks</a>
  </div>

  <!-- Watchlist Section -->
  <div class="tab-panel" id="tab-watchlist" style="display: none;">
    {% if bookmarked_tasks %}
      {% for task in bookmarked_tasks %}
        <div class="task-card">
          <h3>{{ task.title }}</h3>
          <p>ğŸ“ {{ task.location }}<br>ğŸ’° ${{ task.budget }}</p>
          <div class="card-actions">
            <a href="{% url 'job_detail' task.id %}" class="btn-outline">View Details</a>
            <button class="btn-reject">Remove</button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>No bookmarked tasks yet.</p>
    {% endif %}
  </div>

  <!-- Posted Tasks Section -->
  <div class="tab-panel" id="tab-posted">
    {% if posted_tasks %}
      {% for task in posted_tasks %}
        <div class="task-card">
          <div class="task-header">
            <h3>{{ task.title }}</h3>
            <span class="task-budget">${{ task.budget }}</span>
          </div>
          <p class="task-meta">ğŸ“ {{ task.location }}<br>ğŸ“… {{ task.preferred_date }}  â° {{ task.preferred_time }}</p>

          <div class="card-actions">
            <a href="{% url 'job_detail' task.id %}" class="btn-outline>">View Details</a>
            <a href="{% url 'post_task' %}?edit={{ task.id }}" class="btn-outline">Edit</a>
            <button class="btn-reject">Delete</button>
          </div>

          {% if task.offers.all %}
            <div class="offer-section">
              <h5>Offers:</h5>
              {% for offer in task.offers.all %}
              <div class="offer-card">
                <p><strong>{{ offer.offered_by.username }}</strong> â€” ${{ offer.amount }}</p>
                <p class="offer-msg">"{{ offer.message }}"</p>
                <p>Status: {{ offer.status|capfirst }}</p>
                <div class="offer-actions">
                  <button class="btn-accept">Accept</button>
                  <button class="btn-reject">Reject</button>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="no-offers">No offers yet for this task.</p>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>You havenâ€™t posted any tasks yet.</p>
    {% endif %}
  </div>

  <!-- Applied Section -->
  <div class="tab-panel" id="tab-applied" style="display: none;">
    {% if applied_offers %}
      {% for offer in applied_offers %}
        <div class="task-card">
          <h3>{{ offer.task.title }}</h3>
          <p>ğŸ“ {{ offer.task.location }}<br>ğŸ’° ${{ offer.amount }}</p>
          <p>Status: <span class="badge badge-{{ offer.status }}">{{ offer.status|capfirst }}</span></p>
          <p class="offer-msg">Your message: "{{ offer.message }}"</p>
          <div class="card-actions">
            <a href="#" class="btn-outline">Edit Offer</a>
            <button class="btn-reject">Withdraw</button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>You havenâ€™t applied to any tasks yet.</p>
    {% endif %}
  </div>


<!-- Engaged Section -->
<div class="tab-panel" id="tab-engaged" style="display: none;">
  {% if engaged_offers %}
    {% for offer in engaged_offers %}
      <div class="task-card" id="engaged-task-{{ offer.task.id }}">
        <h3>{{ offer.task.title }}</h3>
        <p>ğŸ“ {{ offer.task.location }}<br>ğŸ’° ${{ offer.amount }}</p>
        <p>Engaged with: <strong>{{ offer.task.username }}</strong></p>
        <p class="offer-msg">"{{ offer.message }}"</p>
        <div class="card-actions">
          <button class="btn-accept" onclick="markComplete('{{ offer.id }}')">Mark Complete</button>
          <a href="{% url 'messages' %}?task_id={{ offer.task.id }}" class="btn btn-sm btn-outline-primary">Message</a>
        </div>
        <p class="completion-msg" id="completed-{{ offer.id }}" style="display: none; margin-top: 10px; color: green; font-weight: bold;">
          âœ… Task marked as completed!
        </p>
      </div>
    {% endfor %}
  {% else %}
    <p>No engaged tasks yet.</p>
  {% endif %}
</div>

<!-- Completed Section -->
<div class="tab-panel" id="tab-completed" style="display: none;">
  {% if completed_tasks %}
    {% for item in completed_tasks %}
      <div class="task-card">
        <h3>{{ item.task.title }}</h3>
        <p>ğŸ“ {{ item.task.location }}<br>ğŸ’° ${{ item.task.budget }}</p>
        <p><strong>Completed with:</strong> {{ item.task.username }}</p>
        <div class="card-actions">
          <a href="{% url 'job_detail' item.task.id %}" class="btn-outline">View Details</a>
          <button class="btn-accept" onclick="toggleReviewForm('{{ item.task.id }}')">Leave Review</button>
        </div>

        <!-- Hidden review form -->
        <div class="review-form" id="review-form-{{ item.task.id }}" style="display: none; margin-top: 16px;">
          <form method="post" action="#">
            <label>Rating:</label>
            <div class="star-rating" data-task-id="{{ item.task.id }}">
              {% for i in "12345"|make_list %}
                <span class="star" data-value="{{ forloop.counter }}">â˜†</span>
              {% endfor %}
            </div>
            <input type="hidden" name="rating" id="rating-input-{{ item.task.id }}">

            <label for="comment-{{ item.task.id }}">Feedback:</label>
            <textarea id="comment-{{ item.task.id }}" name="comment" rows="3" placeholder="Leave your comment..."></textarea>

            <button class="btn-accept" type="submit">Submit Review</button>
          </form>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No completed tasks yet.</p>
  {% endif %}
</div>


<script>
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tab-panel');

  tabs.forEach(tab => {
    tab.addEventListener('click', e => {
      e.preventDefault();
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      panels.forEach(panel => panel.style.display = 'none');
      const target = tab.dataset.tab;
      document.getElementById('tab-' + target).style.display = 'block';
    });
  });

  // Function to mark task as complete
  function markComplete(offerId) {
  const button = document.querySelector(`button[onclick="markComplete('${offerId}')"]`);
  const msg = document.getElementById(`completed-${offerId}`);

  if (button && msg) {
    button.disabled = true;
    button.textContent = 'Completed';
    button.style.backgroundColor = '#9ca3af';
    msg.style.display = 'block';
  }
}

  function toggleReviewForm(taskId) {
    const form = document.getElementById(`review-form-${taskId}`);
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
  }

  document.querySelectorAll('.star-rating').forEach(starContainer => {
    const stars = starContainer.querySelectorAll('.star');
    const taskId = starContainer.dataset.taskId;
    const ratingInput = document.getElementById(`rating-input-${taskId}`);

    stars.forEach((star, index) => {
      star.addEventListener('mouseover', () => {
        stars.forEach((s, i) => {
          s.textContent = i <= index ? 'â˜…' : 'â˜†';
        });
      });

      star.addEventListener('click', () => {
        ratingInput.value = index + 1;
      });

      starContainer.addEventListener('mouseleave', () => {
        const selected = parseInt(ratingInput.value);
        stars.forEach((s, i) => {
          s.textContent = i < selected ? 'â˜…' : 'â˜†';
        });
      });
    });
  });


  // tab animation
  tabs.forEach(tab => {
  tab.addEventListener('click', e => {
    e.preventDefault();
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    panels.forEach(panel => {
      panel.style.display = 'none';
      panel.classList.remove('fade-in');
    });

    const target = tab.dataset.tab;
    const activePanel = document.getElementById('tab-' + target);
    activePanel.style.display = 'block';

    // Trigger animation
    void activePanel.offsetWidth; // force reflow
    activePanel.classList.add('fade-in');
  });
});


</script>
{% endblock %}

<!--
  BACKEND NOTE:
  Later, hook the 'Mark Complete' button to a real URL like:
  <form method="POST" action="{% url 'mark_complete' offer.id %}">
    {% csrf_token %}
    <button type="submit" class="btn-accept">Mark Complete</button>
  </form>
-->
